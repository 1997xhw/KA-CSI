# KA-CSI 项目说明文档

基于 **KAN (Kolmogorov-Arnold Networks)** 与 **Transformer** 的 CSI WiFi 活动识别系统。使用双流（幅度 + 相位）与门控融合，支持三种模型架构与完整实验与可视化流程。

---

## 1. 项目概述

### 1.1 功能简介

- **输入**：CSI 幅度与相位数据（如 `*.npy`）
- **输出**：动作类别（如挥手、招手、推、拉、坐下、趴下等）
- **流程**：数据加载 → 双流特征提取（水平/垂直 Transformer + 卷积聚合）→ 门控融合（GRN 或 KAN-GRN）→ 分类

### 1.2 目录结构

```
KA-CSI/
├── train.py                 # 主训练入口：配置、模型工厂、训练器、实验管理
├── run_my_experiments.py     # 批量/按数据集/按模型运行实验
├── data_loader.py           # 数据加载、自动检测 npy、划分 train/val
├── models.py                # THATModel、TwoStreamModel（双流骨干）
├── models2.py               # 另一版 TwoStreamModel（GRE/Gaussian 位置编码）
├── mcat.py                  # MCAT：多头注意力 + HAR_CNN 的 Transformer 编码器
├── transformer_encoder.py   # 标准/相对位置 Transformer（垂直流）
├── position_encoding.py     # GRE、Gaussian、可学习、正弦位置编码
├── grn.py                   # 门控残差网络（MLP 版）
├── kan_grn.py               # KAN 门控残差网络（WaveletKAN 版）
├── WaveletKAN.py            # WaveletKAN 线性层与多层 KAN
├── visualization_data.py   # 混淆矩阵、指标曲线、从 CSV 可视化、对比、趋势分析
├── visualize_results.py     # 命令行可视化工具（single/compare/trend）
├── utils.py                 # 数据归一化、相位解缠、简单 npy 加载
├── check_labels.py          # 检查标签文件形状与分布
├── config_example.json      # 配置示例
├── my_experiment_config.json
├── requirements.txt
├── setup.py
├── README.md / README_training.md / README_visualization.md
└── doc/md/                  # 说明文档（本目录）
```

---

## 2. 模型架构

### 2.1 三种顶层模型（在 train.py 中定义）

| 模型类型       | 说明 |
|----------------|------|
| **THAT_CSI**   | 单流：仅用幅度，一个 `TwoStreamModel` + 线性分类（输出 256 维特征，未接分类器时可用于特征提取） |
| **CA_CSI**     | 双流：幅度 + 相位，两个 `TwoStreamModel`，用 **GRN**（`GatesResidualNetwork`）融合两路 256 维特征后接分类器 |
| **KAN_CA_CSI** | 双流：幅度 + 相位，两个 `TwoStreamModel`，用 **KAN_GRN**（`KAN_GatesResidualNetwork`）融合后接分类器，通常效果最佳 |

### 2.2 双流骨干 TwoStreamModel（models.py）

- **输入**：`[B, T, D]`，如 `T=maxlen`（如 2000），`D=embed_dim`（如 60）。
- **水平流**：
  - 按 `sample` 在时间维下采样（view + sum/mean）。
  - 可学习位置编码 `LearnablePositionalEncoding(embed_dim, maxlen//2)`。
  - **MCAT**：多层 Encoder（MultiHeadAttention + HAR_CNN 的 FFN），输出水平表示。
  - 水平 1D 卷积（kernel 20、40）+ ReLU + 全局 MaxPool，拼接得到水平特征。
- **垂直流**（当 `vlayers > 0`）：
  - 将 `[B, T, D]` reshape 为 `[B, maxlen, D//30, 30]`，对一维求和得到 `[B, maxlen, 30]`，再转置为 `[B, 30, maxlen]`。
  - **Transformer**（支持相对位置注意力）处理，再经垂直 1D 卷积 + 池化，与水平特征拼接。
- **输出**：通过 `feature_proj` 得到 **256 维** 特征（供 KAN_CA_CSI/CA_CSI 融合）；若走分类分支则经 `dense` 得到 logits。

### 2.3 MCAT（mcat.py）

- **MultiHeadAttention** + **HAR_CNN**（多尺度 1D 卷积 + BN + ReLU）作为 FFN 的 Encoder。
- 用于水平序列建模，输入/输出形状一致 `[B, L, hidden_dim]`。

### 2.4 门控融合

- **grn.py — GatesResidualNetwork**  
  - 两个 MLP：`dense_1(x)`、`dense_2(context)`，ELU 激活，`x + context` 后 LayerNorm，再经 `gate_dense` + Sigmoid 得到门控输出。

- **kan_grn.py — KAN_GatesResidualNetwork**  
  - 结构相同，但将线性层替换为 **WaveletKANLinear**，用可学习小波（Mexican Hat、Morlet 等）增强非线性，用于 KAN_CA_CSI。

### 2.5 WaveletKAN（WaveletKAN.py）

- **WaveletKANLinear**：线性变换 + 小波项（scale/translation 可学习），支持 mexican_hat、morlet、dog、meyer、shannon。
- **WaveletKAN**：多层 WaveletKANLinear 堆叠，可选 `regularization_loss`（小波系数 L2）。

---

## 3. 数据与配置

### 3.1 数据格式（data_loader.py）

- **支持类型**：`dataset_type='npy'` 时，从 `root_dir`（或 `root_dir/dataset_type`）自动检测：
  - 幅度：`*_amp_*.npy`、`our_data_amp_*.npy` 等
  - 相位：`*_phase_*.npy`，加载后做 **相位解缠** `np.unwrap(phase, axis=1)`
  - 标签：`*_label_*.npy`、`our_data_label_*.npy` 等
- **划分**：按 8:2 随机划分训练集/验证集。
- **数据集预设类别名**：
  - `our`：Stand up/Squat down、Raise/Lower right hand 等 6 类
  - `stan`：fall、run、lie down、walk、sit down、stand up
  - `wjq`/默认：wave、beckon、push、pull、sitdown、getdown
- **our 数据集**：若幅度/相位最后一维 > 90，会只取前 90 维（天线）。

### 3.2 配置（config_example.json / train.py）

- **model**：`hlayers`、`vlayers`、`hheads`、`vheads`、`K`、`sample`、`maxlen`、`embed_dim`、`num_class`
- **training**：`batch_size`、`epochs`、`learning_rate`
- **data**：`dataset_type`、`root_dir`、`class_names`
- **experiment**：`model_type`（THAT_CSI / CA_CSI / KAN_CA_CSI）、`save_dir`（如 `runs`）

---

## 4. 训练与实验

### 4.1 单次训练（train.py）

```bash
# 默认配置（KAN_CA_CSI）
python train.py

# 指定模型与超参
python train.py --model_type KAN_CA_CSI --epochs 100 --batch_size 8

# 使用配置文件
python train.py --config_file my_config.json
```

- **ExperimentConfig**：合并默认配置与 JSON/字典。
- **ModelFactory**：根据 `model_type` 创建 THAT_CSI / CA_CSI / KAN_CA_CSI。
- **ExperimentManager**：创建时间戳目录、保存 config、**setup_data**（自动更新 `num_class`/`class_names`）、**setup_model**、写 `model_structure.txt`。
- **Trainer**：每个 epoch 训练 + 验证，计算 loss、accuracy、precision、recall、F1，写入 `metrics.csv`；最后一轮保存混淆矩阵与指标曲线图。

### 4.2 批量实验（run_my_experiments.py）

- **create_my_experiment_configs()**：根据 `./data` 下可用数据集自动生成 baseline_kan、baseline_ca、baseline_that 等配置；对 `our` 额外生成 large_model、small_model。
- 用法示例：
  - `--list`：列出所有实验名
  - `--all`：运行全部
  - `--dataset our`：运行该数据集下所有实验
  - `--dataset our --model kan`：运行该数据集的 KAN 模型
  - `--exp_name baseline_kan_our`：运行指定实验
- 结果汇总写入 `my_experiment_results.json`。

---

## 5. 可视化

### 5.1 visualization_data.py

- **draw_confusion_matrix_3**：按类别名绘制混淆矩阵（比例形式），可保存到文件。
- **draw_metrics_curves**：绘制 epoch 的 train/val acc、precision、recall、F1。
- **visualize_from_csv**：从单次实验的 `metrics.csv` 生成曲线与统计摘要。
- **create_comparison_plot**：多实验验证准确率对比。
- **analyze_training_trends**：训练趋势与过拟合等简单分析。

### 5.2 visualize_results.py 命令行

```bash
# 单实验
python visualize_results.py single runs/20231201_143022/metrics.csv

# 多实验对比
python visualize_results.py compare exp1.csv exp2.csv --labels KAN_CA_CSI CA_CSI

# 训练趋势
python visualize_results.py trend runs/xxx/metrics.csv

# 示例用法说明
python visualize_results.py example
```

---

## 6. 其他脚本与工具

- **utils.py**：`normalize_data`、`unwrap_phase`、固定路径的 npy 加载（与 data_loader 的自动检测互为补充）。
- **check_labels.py**：检查指定标签文件的 shape、取值范围、各类别样本数。

---

## 7. 依赖与运行环境

- **requirements.txt**：见项目根目录（典型包含 torch、numpy、scikit-learn、matplotlib、seaborn、pandas、tqdm 等）。
- 训练时使用 **Agg** 后端（`matplotlib.use('Agg')`）避免 GUI 依赖。
- 模型/卷积中部分代码写死 `'cuda'`，无 GPU 时需自行改为 CPU 或 `device` 变量。

---

## 8. 小结

| 模块           | 作用 |
|----------------|------|
| train.py       | 配置、三种模型、训练循环、实验目录与日志 |
| models.py      | THATModel、TwoStreamModel（双流+水平/垂直 Transformer+卷积） |
| mcat.py        | 水平 MCAT Encoder |
| transformer_encoder.py | 垂直 Transformer（含相对位置） |
| position_encoding.py   | 多种位置编码 |
| grn.py / kan_grn.py    | 门控融合（MLP / KAN） |
| WaveletKAN.py  | KAN 线性层与网络 |
| data_loader.py | npy 检测、加载、划分、类别名 |
| run_my_experiments.py  | 批量/按数据集/按模型实验 |
| visualization_data.py / visualize_results.py | 混淆矩阵、曲线、对比、趋势分析 |

本文档描述的是当前代码库中的实现逻辑与使用方式，便于后续维护与扩展。
