# KA-CSI 模块说明

对各 Python 模块的职责、主要类/函数及调用关系做简要说明。

---

## 1. train.py — 训练入口与实验框架

| 类/函数 | 说明 |
|--------|------|
| **ExperimentConfig** | 实验配置：默认 model/training/data/experiment 字典，支持 `_update_config`、`get_*_config()`、`save_config`、`load_config(filepath)` |
| **ModelFactory.create_model(model_type, config, device)** | 根据 `model_type`（THAT_CSI / CA_CSI / KAN_CA_CSI）和 config 创建模型并 to(device) |
| **Trainer** | 接收 model、config、device、run_dir；`train_epoch` / `validate_epoch`；`train()` 多 epoch 循环、写 metrics.csv、最后一轮画混淆矩阵与指标曲线 |
| **ExperimentManager** | 创建时间戳 run_dir、保存 config；`setup_data()` 调用 data_loader 并回写 num_class/class_names；`setup_model()` 创建模型并写 model_structure.txt；`run_experiment()` 串联数据→模型→训练 |
| **THAT_CSI_Model** | 单流：stream1(x_amp) → 256 维（此处返回 feat1，未接分类器） |
| **CA_CSI_Model** | 双流：stream1(x_amp)、stream2(x_phase) → GRN 融合 → classifier → logits |
| **KAN_CA_CSI_Model** | 双流：stream1.extract_feature(x_amp)、stream2.extract_feature(x_phase) → KAN_GRN 融合 → classifier → logits |
| **parse_args()** | 解析命令行（模型/训练/experiment 参数、--config_file） |
| **main()** | 加载配置（文件或 args）→ ExperimentManager → run_experiment |

---

## 2. models.py — 骨干网络

| 类 | 说明 |
|----|------|
| **THATModel** | 单流：sample 下采样 → GRE 位置编码 → MCAT → 可选垂直流 → _aggregate → dense/feature_proj；使用 GRE、固定 kernel 等 |
| **TwoStreamModel** | 双流骨干：可学习位置编码；水平 MCAT + 垂直 Transformer；水平/垂直 1D 卷积 + 池化拼接；`forward` 返回 logits，`extract_feature` 返回 256 维供 KAN_CA_CSI/CA_CSI 融合 |

依赖：`mcat.MCAT`、`position_encoding`（GRE、LearnablePositionalEncoding）、`transformer_encoder.Transformer`。

---

## 3. mcat.py — 水平 Transformer 编码器

| 类 | 说明 |
|----|------|
| **LayerNorm** | 标准 LayerNorm（alpha/bias 可学习） |
| **SublayerConnection** | norm → sublayer → dropout + 残差 |
| **MultiHeadAttention** | 多头缩放点积注意力，mask 支持 |
| **HAR_CNN** | 多尺度 1D 卷积（filters 如 [1,3,5]）+ BN + ReLU + 均值聚合 |
| **EncoderLayer** | self_attn + feed_forward，各带 SublayerConnection |
| **Encoder** | N 个 EncoderLayer + 最后 LayerNorm |
| **MCAT(hidden_dim, N, H, total_size, filters)** | Encoder(MultiHeadAttention + HAR_CNN)，用于水平序列 |

---

## 4. transformer_encoder.py — 垂直流 Transformer

| 类 | 说明 |
|----|------|
| **MultiHeadedAttention** | 标准多头注意力 |
| **RelativeMultiHeadAttention** | 带相对位置嵌入的相对注意力 |
| **Transformer(hidden_dim, N, H, use_relative, max_len)** | N 层 EncoderLayer（注意力 + PositionwiseFeedForward），可选相对位置 |
| **PositionalEncoding** | 正弦位置编码（buffer），batch 维广播 |

---

## 5. position_encoding.py — 位置编码

| 类 | 说明 |
|----|------|
| **GRE(d_model, total_size, K)** | 高斯径向基位置编码，可学习 mu/sigma 与 embedding |
| **Gaussian_Position** | 类似 GRE，positions 固定到 cuda |
| **LearnablePositionalEncoding(d_model, max_len)** | 可学习 `pe [1, max_len, d_model]`，与输入相加 |
| **SinusoidalPositionalEncoding** | 正弦/余弦固定编码，buffer |

---

## 6. grn.py / kan_grn.py — 门控融合

| 模块 | 类 | 说明 |
|------|-----|------|
| grn | **GatesResidualNetwork(units)** | dense_1(x)、dense_2(context)、ELU、x+context、LayerNorm、gate_dense、Sigmoid → gate 输出 |
| kan_grn | **KAN_GatesResidualNetwork(units)** | 同上结构，线性层改为 WaveletKANLinear（来自 WaveletKAN） |

---

## 7. WaveletKAN.py — KAN 层

| 类 | 说明 |
|----|------|
| **WaveletKANLinear(in_f, out_f, wavelet_type, ...)** | 线性 base 项 + 小波项（scale/translation 可学习）；wavelet_type: mexican_hat, morlet, dog, meyer, shannon；`regularization_loss()` 小波系数 L2 |
| **WaveletKAN(layers_hidden, ...)** | 多层 WaveletKANLinear 堆叠；`regularization_loss()` 求和各层 |

---

## 8. data_loader.py — 数据加载

| 函数 | 说明 |
|------|------|
| **detect_data_files(data_dir)** | 按 pattern 检测 amp/phase/label 的 npy 路径 |
| **load_numpy_data(data_dir)** | 检测并加载 amp、phase（相位 unwrap）、label，校验样本数一致 |
| **get_class_names(dataset_type, root_dir)** | 根据 dataset_type/路径返回预设 class_names（our/stan/wjq 等） |
| **get_dataloader(dataset_type, root_dir, batch_size, ...)** | 加载 npy、TensorDataset、8:2 划分、DataLoader、返回 train_loader, val_loader, class_names |
| **list_available_datasets(root_dir)** | 遍历子目录，检测含数据文件的目录名列表 |

---

## 9. run_my_experiments.py — 批量实验

| 函数 | 说明 |
|------|------|
| **create_my_experiment_configs()** | 根据 list_available_datasets 为每个数据集生成 baseline_kan/ca/that；our 额外生成 large_model、small_model |
| **run_single_experiment(exp_name, config_dict)** | ExperimentConfig → ExperimentManager → run_experiment |
| **run_all_experiments()** | 跑全部配置，结果写 my_experiment_results.json |
| **run_specific_experiment(exp_name)** | 只跑指定实验名 |
| **run_dataset_experiments(dataset_name)** | 只跑名称中含该数据集的所有实验 |
| **run_dataset_model_experiment(dataset_name, model_type)** | 跑 baseline_{model}_{dataset} |

命令行：`--list`、`--all`、`--dataset`、`--model`、`--exp_name`。

---

## 10. visualization_data.py — 绘图与分析

| 函数 | 说明 |
|------|------|
| **draw_confusion_matrix_3(y_true, y_pred, class_names, save_path)** | 混淆矩阵（比例）+ 可选保存 |
| **draw_metrics_curves(epochs, train_acc, val_acc, precision, recall, f1, save_path)** | 多条指标随 epoch 曲线 |
| **visualize_from_csv(csv_file_path, ...)** | 从 metrics.csv 读并生成曲线、统计摘要 |
| **create_comparison_plot(csv_files, labels, ...)** | 多实验验证准确率对比图 |
| **analyze_training_trends(csv_file_path, ...)** | 训练趋势与简单过拟合分析 |

---

## 11. visualize_results.py — 命令行可视化

- **main()**：子命令 `single` / `compare` / `trend` / `example`，调用 visualization_data 中对应函数。
- **interactive_mode()**：简单交互菜单（可选使用）。

---

## 12. utils.py

- `normalize_data(data)`：Min-Max 归一化。
- `unwrap_phase(phase)`：`np.unwrap(phase)`。
- `load_numpy_data(root)`：固定文件名加载 our_data_amp/phase/label npy（与 data_loader 的自动检测互补）。

---

## 13. check_labels.py

- **check_labels()**：加载指定标签 npy，打印 shape、取值范围、唯一值及各类别样本数。

---

以上为 KA-CSI 各模块的简要说明，便于快速定位与二次开发。
